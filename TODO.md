# RAG Notes 功能开发 TODO

本文档跟踪 RAG Notes 项目的功能开发任务。

```
这四个核心任务，其实就在做三件事：**优化提问、优化切片、优化投喂。**

---

### 1. 优化提问 (查询改写)

* **目的：** 把用户难懂的口语（尤其是多轮对话中的“它”、“那个”）翻译成标准的搜索词。
* **价值：** 解决**“搜不到”**的问题，是多轮对话的刚需。

### 2. 优化切片 (语义分块 & 父文档检索)

* **语义分块：** 按“意思”切，不按“字数”切，保证逻辑完整。
* **父文档：** 搜索时用精准的“小块”，回答时给完整的“大背景”。
* **价值：** 解决**“上下文断裂”**的问题，让大模型读得懂前因后果。

### 3. 优化投喂 (上下文压缩)

* **目的：** 在把搜到的内容给大模型前，先“划重点”去废话。
* **价值：** 解决**“信息过载”**的问题，既能**省 Token 钱**，又能**提高准确度**。

---

**一句话总结：**
**改写**让你搜得准，**分块/父文档**让内容有逻辑，**压缩**让大模型只看重点。

既然你在开发，建议优先级：**查询改写 (多轮必备) > 父文档检索 (效果最明显) > 上下文压缩 (省钱/精简) > 语义分块 (后期调优)**。

需要我帮你写其中某个模块的具体实现逻辑吗？
```

## 📋 待开发功能

### 🚀 初级进阶功能

#### [ ] 1. 流式响应（Streaming Response）
- [ ] 修改 `query_engine.py` 支持流式输出
- [ ] 更新 `app.py` 使用 Gradio 的流式组件
- [ ] 测试流式响应功能
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐  
**预计时间**: 2-3小时

---

#### [ ] 2. 多轮对话支持（Chat History）
- [ ] 实现对话历史存储（内存或数据库）
- [ ] 创建 ChatEngine 封装
- [ ] 更新 `app.py` 添加对话界面
- [ ] 实现查询改写（基于对话历史）
- [ ] 测试多轮对话
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐  
**预计时间**: 4-6小时

---

#### [ ] 3. 元数据过滤（Metadata Filtering）
- [ ] 扩展索引时的元数据保存
- [ ] 实现 MetadataFilter 查询接口
- [ ] 更新 UI 添加过滤选项（文件选择器）
- [ ] 测试元数据过滤功能
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐  
**难度**: ⭐⭐  
**预计时间**: 3-4小时

---

### 🎯 中级进阶功能

#### [ ] 4. 重排序（Reranking）
- [ ] 选择 reranker 方案（Cohere API 或本地 BGE）
- [ ] 安装必要依赖（如 sentence-transformers）
- [ ] 实现 RerankPostprocessor
- [ ] 集成到 query_engine
- [ ] 添加配置选项（reranker 模型选择）
- [ ] 性能测试和效果对比
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐  
**预计时间**: 5-7小时

---

#### [ ] 5. 混合检索（Hybrid Search）
- [ ] 研究 PostgreSQL 全文搜索（tsvector）
- [ ] 实现 BM25 检索器（或使用 rank-bm25）
- [ ] 实现 RRF 融合策略
- [ ] 创建 HybridRetriever
- [ ] 集成到查询引擎
- [ ] 性能测试和效果对比
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐  
**预计时间**: 8-12小时

---

#### [ ] 6. 查询改写/扩展（Query Transformation）
- [ ] 实现 Multi-Query Retriever
- [ ] 添加查询改写管道
- [ ] 添加配置选项
- [ ] 测试查询改写效果
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐  
**预计时间**: 4-6小时

---

#### [ ] 7. 上下文压缩（Context Compression）
- [ ] 实现 ContextCompressionRetriever
- [ ] 选择压缩策略（LLM Extractor 或 Embedding）
- [ ] 集成到查询引擎
- [ ] 测试压缩效果和 token 节省
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐  
**预计时间**: 5-7小时

---

### 🔬 高级进阶功能

#### [ ] 8. 评估框架（Evaluation Framework）
- [ ] 创建测试数据集
- [ ] 实现评估指标（Faithfulness、Relevancy）
- [ ] 实现批量评估功能
- [ ] 添加评估结果可视化
- [ ] 创建评估报告生成
- [ ] 集成到 UI 或 CLI
- [ ] 更新文档

**优先级**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐  
**预计时间**: 10-15小时

---

#### [ ] 9. 父文档检索（Parent Document Retriever）
- [ ] 设计层次化文档结构
- [ ] 修改索引逻辑保存父子关系
- [ ] 实现 ParentRetriever
- [ ] 集成到查询引擎
- [ ] 测试效果
- [ ] 更新文档

**优先级**: ⭐⭐⭐  
**难度**: ⭐⭐⭐⭐  
**预计时间**: 8-10小时

---

#### [ ] 10. 语义分块（Semantic Chunking）
- [ ] 研究语义分块算法
- [ ] 实现 SemanticSplitterNodeParser
- [ ] 修改索引逻辑使用语义分块
- [ ] 对比固定分块 vs 语义分块效果
- [ ] 更新文档

**优先级**: ⭐⭐⭐  
**难度**: ⭐⭐⭐⭐  
**预计时间**: 6-8小时

---

#### [ ] 11. 多索引/文档集合管理
- [ ] 设计索引命名空间方案
- [ ] 实现索引创建、删除、切换逻辑
- [ ] 更新 UI 添加集合管理界面
- [ ] 实现集合元数据管理
- [ ] 测试多集合功能
- [ ] 更新文档

**优先级**: ⭐⭐⭐  
**难度**: ⭐⭐⭐  
**预计时间**: 6-8小时

---

#### [ ] 12. 答案引用增强
- [ ] 在索引时保存位置信息（页码、段落号等）
- [ ] 实现引用标记生成
- [ ] 更新答案生成逻辑插入引用
- [ ] 改进 UI 显示引用（可选：可点击跳转）
- [ ] 测试引用准确性
- [ ] 更新文档

**优先级**: ⭐⭐  
**难度**: ⭐⭐⭐  
**预计时间**: 5-7小时

---

## 📝 其他改进任务

### 代码质量
- [ ] 添加单元测试
- [ ] 添加集成测试
- [ ] 代码格式化和 linting
- [ ] 类型注解完善
- [ ] 错误处理改进

### 文档
- [ ] API 文档生成
- [ ] 使用示例完善
- [ ] 架构设计文档
- [ ] 性能优化指南

### 用户体验
- [ ] UI/UX 改进
- [ ] 加载状态提示
- [ ] 错误消息优化
- [ ] 响应式设计

---

## ✅ 已完成功能

- [x] 基础文档索引
- [x] 向量检索
- [x] LLM 生成答案
- [x] Chunk 级别去重
- [x] Phoenix observability

---

## 📊 进度统计

- **总计**: 12 个主要功能
- **已完成**: 0 个
- **进行中**: 0 个
- **待开始**: 12 个

---

## 🎯 当前冲刺目标

建议按以下顺序实现：

1. **流式响应** - 快速提升用户体验
2. **多轮对话** - 理解对话管理
3. **重排序** - 显著提升检索质量
4. **评估框架** - 量化改进效果

---

## 📌 注意事项

- 每个功能实现后应该充分测试
- 保持向后兼容性
- 更新相关文档
- 考虑性能影响
- 评估对现有功能的影响

