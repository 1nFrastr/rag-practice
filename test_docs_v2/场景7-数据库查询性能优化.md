# 数据库查询性能优化

本文档介绍如何优化数据库查询以提升系统性能。

## 索引优化

### 创建合适的索引

```sql
-- 为常用查询字段创建索引
CREATE INDEX idx_users_email ON users(email);

-- 复合索引（注意字段顺序）
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at DESC);
```

### 分析查询计划

```sql
-- PostgreSQL
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

-- MySQL
EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
```

## SQL优化技巧

### 1. 避免SELECT *
```sql
-- 不推荐
SELECT * FROM orders;

-- 推荐
SELECT id, user_id, total, created_at FROM orders;
```

### 2. 避免在WHERE子句中对字段使用函数
```sql
-- 不推荐（无法使用索引）
SELECT * FROM orders WHERE YEAR(created_at) = 2024;

-- 推荐
SELECT * FROM orders WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01';
```

### 3. 使用LIMIT限制结果集
```sql
SELECT * FROM logs ORDER BY created_at DESC LIMIT 100;
```

## 连接池配置

```python
# SQLAlchemy连接池配置
engine = create_engine(
    DATABASE_URL,
    pool_size=10,          # 连接池大小
    max_overflow=20,       # 最大溢出连接数
    pool_recycle=3600      # 连接回收时间
)
```

## 读写分离

- 写操作走主库
- 读操作走从库
- 使用中间件自动路由

## 监控与调优

定期检查慢查询日志，针对性优化。
