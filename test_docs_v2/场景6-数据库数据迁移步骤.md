# 数据库数据迁移步骤

将数据从旧数据库迁移到新数据库的完整指南。

## 迁移前准备

### 1. 评估工作量
- 统计数据量：表数量、总记录数、数据大小
- 分析表结构：主键、外键、索引
- 识别特殊类型：BLOB、JSON、枚举

### 2. 制定迁移计划
```
预计时间线：
- 第1天：环境准备、工具配置
- 第2天：测试环境迁移验证
- 第3天：正式迁移（安排维护窗口）
```

## 迁移步骤

### 步骤1：导出旧数据库数据

```bash
# PostgreSQL
pg_dump -h old-server -U postgres -Fc --no-owner mydb > mydb.dump

# MySQL
mysqldump -h old-server -u root -p --single-transaction mydb > mydb.sql
```

### 步骤2：在新数据库创建结构

```bash
# 只导出结构（不含数据）
pg_dump -h old-server -U postgres --schema-only mydb > schema.sql

# 在新数据库执行
psql -h new-server -U postgres -d mydb -f schema.sql
```

### 步骤3：导入数据

```bash
# PostgreSQL
pg_restore -h new-server -U postgres -d mydb mydb.dump

# MySQL
mysql -h new-server -u root -p mydb < mydb.sql
```

### 步骤4：验证数据一致性

```sql
-- 对比记录数
SELECT 'users' as table_name, COUNT(*) FROM users
UNION ALL
SELECT 'orders', COUNT(*) FROM orders;

-- 抽样验证关键数据
SELECT * FROM users WHERE id IN (1, 100, 1000);
```

### 步骤5：更新应用配置

修改应用的数据库连接字符串，指向新数据库。

## 回滚方案

如果迁移失败，立即切换回旧数据库：
1. 更新应用配置指向旧库
2. 分析失败原因
3. 修复后重新迁移
